<html>
<head>

<title>Escape!</title>

</head>

<body style="display: none;">

<div id="display" style="text-align: center;">
	<div id="message" style="font-size: 40px; padding: 20px;">Click Play to start!</div>
	<div id="timer" style="font-size: 90px; padding: 20px;"></div>
</div>
<center style="padding: 5px;"><button id="submit" style="width: 50%; height: 100px; font-size: 40px;">Start</button></center>

<div style="display: none;">
	<!-- from https://freesound.org/browse/tags/sound-effects/ -->
	<audio id="gong" src="https://raw.githubusercontent.com/madelson/Escape/master/gong.wav"></audio>
	<audio id="cymbal" src="https://raw.githubusercontent.com/madelson/Escape/master/cymbal.wav"></audio>
	<audio id="coundown" src="https://raw.githubusercontent.com/madelson/Escape/master/coundown.mp3"></audio>
</div>


<script
  type="text/javascript"
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>

<!-- earlier version at https://jsfiddle.net/jhpvLufb/33/ -->
  
<script type="text/javascript">

var steps = [
	{ 
  	text: "Paused: click Resume to play or refresh the page to reset."
  },
  {
	text: "Get ready...",
	length: 5, // needs to match countdown
	color: "crimson",
	sound: "countdown"
	},
  { 
  	text: "Round 1: Explore the temple!", 
    length: 220,
    color: "lime"
  },
  { 
  	text: "Return 1: Return to the start room!", 
    length: 40,
    color: "yellow",
	sound: "gong"
  },
  { 
  	text: "Round 2: Explore the temple!", 
    length: 140,
    color: "green",
	sound: "cymbal"
  },
  { 
  	text: "Return 2: Return to the start room!",
    length: 40,
    color: "yellow",
	sound: "gong"
  },
  { 
  	text: "Round 3: Explore the temple!", 
    length: 120,
	color: "darkgreen",
	sound: "cymbal"
  },
  { 
  	text: "ESCAPE!", 
    length: 40,
    color: "red",
	sound: "gong"
  },
  {
  	text: "OUT OF TIME!",
    color: "red",
	sound: "cymbal"
  }
];

// state
var currentStep = 0;
var pausedStep = 1;
var stepSecondsRemaining = null;
var currentTimeout = null;

function formatTime(seconds) {
  if (seconds === null) { return ""; }

  var minutesPart = Math.floor(seconds / 60);
  var secondsPart = seconds - (60 * minutesPart);
  return minutesPart + ":" + (secondsPart < 10 ? "0" : "") + secondsPart;
}

var currentlyPlaying = null;
function playAudio(id) {
	if (currentlyPlaying) { 
		currentlyPlaying.pause();
	}
	if (typeof id === "string") {
		currentlyPlaying = document.getElementById(id);
		currentlyPlaying.currentTime = 0;
		currentlyPlaying.play();
	}
}

function executeStep() {
  var display = document.getElementById("display");
  var message = document.getElementById("message");
  var timer = document.getElementById("timer");
  var submit = document.getElementById("submit");
  var step = steps[currentStep]; 
  
  if (typeof step.length === "number" && stepSecondsRemaining === null) {
  	stepSecondsRemaining = step.length;
  }
  
  playAudio(step.sound);
  display.style.backgroundColor = step.color || "white";
  message.innerHTML = step.text;
  timer.innerHTML = formatTime(stepSecondsRemaining);
  submit.innerHTML = typeof step.length === "number" ? "Pause" : "Resume";
  
  if (typeof step.length === "number") {    
    function tick() {
		timer.innerHTML = formatTime(stepSecondsRemaining);
		if (stepSecondsRemaining > 0) {
			currentTimeout = window.setTimeout(tick, 1000);
			stepSecondsRemaining--;
		} else {
			stepSecondsRemaining = null;
			currentStep++;
			executeStep();
		} 
    }
    
    tick();
  }
}

$(window).on("load", function () {
	// if we loaded without a cache buster, reload with a cache buster
	if (window.location.href.indexOf("cb=") < 0) {
		window.location.href += "?&cb=" + Date.now();
		return;
	}	
	
	// check for debug speedup
	var speedupFactor; 
	if (window.location.href.toLowerCase().indexOf("speedup=medium") >= 0) {
		speedupFactor = .1;
		console.log("speedup x " + (1 / speedupFactor));
	} else if (window.location.href.toLowerCase().indexOf("speedup=high") >= 0) {
		speedupFactor = .05;
		console.log("speedup x " + (1 / speedupFactor));
	} else {
		speedupFactor = 1;
	}
	for (var i = 0; i < steps.length; ++i) {
		if (typeof steps[i].length === "number") {
			steps[i].length *= speedupFactor;
		}
	}	

	document.getElementById("submit").onclick = function() { 
		if (pausedStep !== null) {
		currentStep = pausedStep;
		pausedStep = null;
	  } else {
		pausedStep = currentStep;
		currentStep = 0;
		window.clearTimeout(currentTimeout);
	  }
	  
	  executeStep();
	};
	
	$('body').css({ display: "inline" });
});
</script>

</body>
</html>
